name: Daily Update

on:
    schedule:
        - cron: "0 0 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3.5.3

      - name: Get latest Home Assistant version
        id: hassversion
        run: |
            latest_version_homeassistant=$(curl -sL https://api.github.com/repos/home-assistant/core/releases/latest | jq -r '.tag_name' | sed -e 's/v//')
            echo "Latest version Home-Assistant: $latest_version_homeassistant"
            echo "version_hassio=$latest_version_homeassistant" >> $GITHUB_ENV
            latest_version_hacs=$(curl -sL https://api.github.com/repos/hacs/integration/releases/latest | jq -r '.tag_name' | sed -e 's/v//')
            echo "Latest version HACS: $latest_version_hacs"
            echo "version_hacs=$latest_version_hacs" >> $GITHUB_ENV

      - name: Read JSON file and set environment variables
        env:
            JSON_FILE: ${{ github.workspace }}/hacs.json
        run: |
            homeassistant=$(jq -r '.homeassistant' "${JSON_FILE}")
            hacs=$(jq -r '.hacs' "${JSON_FILE}")
            echo "homeassistant=${homeassistant}" >> $GITHUB_ENV
            echo "hacs=${hacs}" >> $GITHUB_ENV

      - name: Check status
        id: check_status
        run: |
            if [ "${{ env.version_hacs }}" == "null" ] || [ "${{ env.version_hassio }}" == "null" ]; then
                echo "match=true" >> $GITHUB_OUTPUT
            fi
            if [ "${{ env.hacs }}" = "${{ env.version_hacs }}" ]; then
                echo "hacs_equal=${{ env.hacs }} (no update)" >> $GITHUB_ENV
            else
                echo "hacs_equal=${{ env.hacs }} â†’ ${{ env.version_hacs }}" >> $GITHUB_ENV
            fi
            if [ "${{ env.homeassistant }}" = "${{ env.version_hassio }}" ]; then
                echo "hassio_equal=${{ env.homeassistant }} (no update)" >> $GITHUB_ENV
            else
                echo "hassio_equal=${{ env.homeassistant }} â†’ ${{ env.version_hassio }}" >> $GITHUB_ENV
            fi

      - name: Update hacs.json file
        if: steps.check_status.outputs.match != 'true'
        run: |
            python3 ${{ github.workspace }}/scripts/update/hacs.py --hversion ${{ env.version_hassio }} --version ${{ env.version_hacs }}

      - name: Create Pull Request
        if: steps.check_status.outputs.match != 'true'
        uses: peter-evans/create-pull-request@v5.0.2
        with:
            token: ${{ secrets.GITHUB_TOKEN }}
            commit-message: Update hacs.json file
            committer: github-actions[bot] <noreply@github.com>
            author: github-actions[bot] <noreply@github.com>
            signoff: true
            branch: "update_hacs_hassio"
            delete-branch: true
            title: 'ðŸ”¨ Update hacs.json file by <github-actions[bot]>'
            body: |
                Update report
                - HACS version: ${{ env.hacs_equal }}
                - Home-Assistant version: ${{ env.hassio_equal }}
                
                Auto-generated by [create-pull-request][1]

                [1]: https://github.com/peter-evans/create-pull-request
            labels: |
                wait
                in progress
                bot
            reviewers: Ludy87
            draft: false
